<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - MediRecord Pro</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/auth.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Custom JS -->
    <script src="../../assets/js/supabase-config.js"></script>
    <script src="../../assets/js/auth.js"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Crear Cuenta</h1>
                <p>√önete a MediRecord Pro</p>
            </div>

            <form id="registerForm" class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Nombre</label>
                        <input type="text" id="firstName" name="firstName" required 
                               placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label for="lastName">Apellido</label>
                        <input type="text" id="lastName" name="lastName" required 
                               placeholder="Tu apellido">
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="ejemplo@correo.com">
                </div>

                <div class="form-group">
                    <label for="phone">Tel√©fono</label>
                    <input type="tel" id="phone" name="phone" required 
                           placeholder="+52 123 456 7890">
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <div class="password-input">
                        <input type="password" id="password" name="password" required 
                               placeholder="M√≠nimo 6 caracteres">
                        <button type="button" class="toggle-password" 
                                onclick="togglePassword('password')">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Contrase√±a</label>
                    <div class="password-input">
                        <input type="password" id="confirmPassword" name="confirmPassword" required 
                               placeholder="Repite tu contrase√±a">
                        <button type="button" class="toggle-password" 
                                onclick="togglePassword('confirmPassword')">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tipo de Usuario</label>
                    <div class="role-selection">
                        <div class="role-option" onclick="selectRole('patient')">
                            <input type="radio" id="patient" name="role" value="patient" checked>
                            <label for="patient">Paciente</label>
                        </div>
                        <div class="role-option" onclick="selectRole('doctor')">
                            <input type="radio" id="doctor" name="role" value="doctor">
                            <label for="doctor">M√©dico</label>
                        </div>
                        <div class="role-option" onclick="selectRole('nurse')">
                            <input type="radio" id="nurse" name="role" value="nurse">
                            <label for="nurse">Enfermero/a</label>
                        </div>
                        <div class="role-option" onclick="selectRole('staff')">
                            <input type="radio" id="staff" name="role" value="staff">
                            <label for="staff">Personal</label>
                        </div>
                    </div>
                </div>

                <!-- Campos adicionales para m√©dicos -->
                <div id="doctorFields" class="doctor-fields" style="display: none;">
                    <div class="form-group">
                        <label for="specialty">Especialidad</label>
                        <select id="specialty" name="specialty">
                            <option value="">Selecciona una especialidad</option>
                            <option value="medicina_general">Medicina General</option>
                            <option value="cardiologia">Cardiolog√≠a</option>
                            <option value="neurologia">Neurolog√≠a</option>
                            <option value="pediatria">Pediatr√≠a</option>
                            <option value="ginecologia">Ginecolog√≠a</option>
                            <option value="traumatologia">Traumatolog√≠a</option>
                            <option value="dermatologia">Dermatolog√≠a</option>
                            <option value="psiquiatria">Psiquiatr√≠a</option>
                            <option value="oftalmologia">Oftalmolog√≠a</option>
                            <option value="otorrinolaringologia">Otorrinolaringolog√≠a</option>
                            <option value="urologia">Urolog√≠a</option>
                            <option value="oncologia">Oncolog√≠a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="licenseNumber">N√∫mero de C√©dula</label>
                        <input type="text" id="licenseNumber" name="licenseNumber" 
                               placeholder="N√∫mero de c√©dula profesional">
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="terms" required>
                        <span class="checkmark"></span>
                        Acepto los <a href="#" target="_blank">t√©rminos y condiciones</a>
                    </label>
                </div>

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="privacy" required>
                        <span class="checkmark"></span>
                        Acepto la <a href="#" target="_blank">pol√≠tica de privacidad</a>
                    </label>
                </div>

                <div id="messageContainer" class="message-container"></div>

                <button type="submit" id="registerButton" class="btn btn-primary btn-block" 
                        data-original-text="Crear Cuenta">
                    Crear Cuenta
                </button>
            </form>

            <div class="auth-footer">
                <p>¬øYa tienes una cuenta? 
                    <a href="login.html">Inicia sesi√≥n aqu√≠</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Manejar selecci√≥n de rol
        function selectRole(role) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Seleccionar nuevo rol
            document.querySelector(`input[value="${role}"]`).checked = true;
            document.querySelector(`input[value="${role}"]`).closest('.role-option').classList.add('selected');
            
            // Mostrar/ocultar campos de m√©dico
            const doctorFields = document.getElementById('doctorFields');
            if (role === 'doctor') {
                doctorFields.style.display = 'block';
                document.getElementById('specialty').required = true;
                document.getElementById('licenseNumber').required = true;
            } else {
                doctorFields.style.display = 'none';
                document.getElementById('specialty').required = false;
                document.getElementById('licenseNumber').required = false;
            }
        }

        // Inicializar selecci√≥n por defecto
        document.addEventListener('DOMContentLoaded', () => {
            selectRole('patient');
        });

        // Manejar env√≠o del formulario
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');
            const email = formData.get('email');
            const phone = formData.get('phone');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            const role = formData.get('role');
            const specialty = formData.get('specialty');
            const licenseNumber = formData.get('licenseNumber');
            
            // Validaciones
            if (!authManager.isValidEmail(email)) {
                showMessage('messageContainer', 'Por favor, ingresa un correo electr√≥nico v√°lido');
                return;
            }

            if (!authManager.isValidPassword(password)) {
                showMessage('messageContainer', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('messageContainer', 'Las contrase√±as no coinciden');
                return;
            }

            if (role === 'doctor' && (!specialty || !licenseNumber)) {
                showMessage('messageContainer', 'Los m√©dicos deben completar especialidad y n√∫mero de c√©dula');
                return;
            }

            // Mostrar loading
            showLoading('registerButton', true);

            // Preparar datos del usuario
            const userData = {
                full_name: `${firstName} ${lastName}`,
                phone: phone,
                role: role,
                specialty: specialty || null,
                license_number: licenseNumber || null
            };

            // Intentar registro
            const result = await authManager.signUp(email, password, userData);
            
            if (result.success) {
                showMessage('messageContainer', 
                    '¬°Registro exitoso! Revisa tu correo para verificar tu cuenta.', 
                    'success');
                // Limpiar formulario
                document.getElementById('registerForm').reset();
                selectRole('patient');
            } else {
                showMessage('messageContainer', result.error);
            }
            
            showLoading('registerButton', false);
        });

        // Funci√≥n para mostrar/ocultar contrase√±a
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }
    </script>
</body>
</html>
